#### CURRENT STAGE OF THIS DOCUMENT: Rapidly changing, highly incomplete, rough notes to self.

.Required preparation that is not yet covered
* Establish an IP schema for the cluster. In this document, admin is 172.16.241.200, the master and three worker nodes are 172.16.241.105-108


.Install the Management Workstation:

* Can be a VM, as long as it has access to the Internet and the cluster network
* 4 vCPU, 4096MB mem, 20GB qcow2 boot drive in default libvirt location
* Booting from ISO: Select "Installation" BUT DO NOT PRESS ENTER
* On "Boot Options:" line: `ifcfg=eth0=172.16.241.200/24,172.16.241.254,172.16.250.2,caaspv4.com hostname=admin.caaspv4.com`
** Press Enter
* Use the CaaS Platform subscription key to register SLES 15 SP1
** Enable the following repositories:
*** SUSE CaaS Platform 4.0 
**** Should automatically enable Basesystem Module and Containers Module
*** SUSE Package Hub
*** Desktop Applications Module (Only if you want a desktop available on the Management Workstation)
*** Legacy Module
* For partitioning, select Guided Setup
** Keep defaults except deselect "Enlarge to RAM Size for Suspend"
* Create New User:
** User's Full Name and Username: sles
** Select "Use this password for system administrator" and Automatic Login
* On the final "Installation Settings" screen:
** Under Security, disable the Firewall
* Install


.Install cluster nodes:

* Current attempt is based around: 
** Finishing the prep for the Management workstation:
*** sudo bash -c "echo 'sles ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers"
*** ssh-keygen
*** cat ~/.ssh/id_rsa.pub > ~/.ssh/authorized_keys
*** sudo yast timezone
**** other Settings
**** Synchronize with NTP server
**** Synchronize now
**** Run NTP as daemon
**** Save NTP Configuration
**** Accept, then OK

** Creating an autoyast clone of the Management Workstation
*** sudo yast2 clone_system
**** Approve the installation of the AutoYaST2 package
*** mkdir autoyast_templates
*** `sudo mv /root/autoinst.xml ~/autoyast_templates/master.xml`
*** `sudo chmod -R 777 ~/autoyast_templates/`
*** cd autoyast_templates/; vim master.xml
**** Search for <\/hostname
***** Change hostname from admin to master
**** Search for <ipaddr
***** Change the IP address to that of the master. In this document it is 172.16.241.105
**** Search for <device>\/dev
***** If the Master Node is a VM, ensure this device is /dev/vda
***** If the Master Node is a bare-metal server, ensure this device is /dev/sda
*** If the Master Node is a VM, remove the line `<service>spice-vdagentd</service>`
*** Add the following element at the top, right below <profile ... > and update with correct email and reg code
  <suse_register>
    <do_registration config:type="boolean">true</do_registration>
    <email>tux@example.com</email>
    <reg_code>MY_SECRET_REGCODE</reg_code>
    <install_updates config:type="boolean">true</install_updates>
    <slp_discovery config:type="boolean">false</slp_discovery>
  </suse_register>

*** Create the /home/sles/autoyast_post_updates.sh file
**** `echo "echo 'sles ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers" >> /home/sles/autoyast_post_updates.sh`
*** Add the following element
  <scripts>
    <post-scripts config:type="list">
      <script>
        <debug config:type="boolean">true</debug>
        <feedback config:type="boolean">false</feedback>
        <feedback_type/>
        <filename>autoyast_post_updates.sh</filename>
        <interpreter>shell</interpreter>
        <location><![CDATA[/home/sles/autoyast_templates/autoyast_post_updates.sh]]></location>
        <notification>Performing_Final_Updates</notification>
        <param-list config:type="list"/>
        <source><![CDATA[]]></source>
      </script>
    </post-scripts>
  </scripts>


** Setting up Docker and the nginx webserver
*** sudo zypper -n in docker
*** sudo systemctl start docker.service && sudo systemctl enable docker.service
*** sudo usermod -aG docker sles ; sudo su - sles
*** Launch nginx container: docker run --name autoyast-nginx -v /home/sles/autoyast_templates:/usr/share/nginx/html:ro -P -d nginx:latest
*** docker ps
**** Set this variable to the port listed under PORTS: NGINX_PORT=""
*** Test that the master autoyast file is available: `curl http://admin.caaspv4.com:$NGINX_PORT/master.xml`

** AutoYaST installing the Master Node
**** On Installation line: `autoyast=http://admin.caaspv4.com:<nginx port>/master.xml ifcfg=eth0=<IP of master>/24,<IP of gateway>,<IP of DNS server,<search domain> hostname=master.caaspv4.com

** Adjust Master Node networking to suit environment. In this document we are creating a bonded network from eth0
    and eth1, then assigning the node's IP address to that bond. Your configuration may be different.
TIP: In yast, Tab will help you navigate through panes and options. Each option in yast will have a letter highlighted.
     Using "Alt" + that letter will directly open that option.
*** sudo yast lan
*** (Highlight eth0) -> Delete -> OK
*** sudo yast lan
*** Add -> Device Type -> Bond -> Next
*** (Select Statically Assigned IP Address) -> IP Address -> (input the Master Node's IP address)
*** (Adjust the Subnet Mask, if needed) -> Bonded Slaves -> Yes
*** (Select both eth0 and eth1) -> Next
*** Routing -> (Ensure the Device for Default IPv4 Gateway is -) -> OK
** Verify networking is functioning correctly:
*** ip a
*** ping google.com

** Creating an autoyast clone of the Master Node
*** yast2 clone_system
*** SCP the AutoYaST file to the Management Workstation. This will overwrite the original master.xml file. Make a copy first, if needed.
**** sudo scp /root/autoinst.xml admin.caaspv4.com:/home/sles/autoyast_templates/master.xml


** Copying and adjusting the autoinst.xml file for each worker node
** AutoYaST installing the Worker Nodes


Install master node:
Deploy Deployment host O/S: Set IP on Grub line, enable repos: CaaSPv4, Containers, Package Hub
* Can enable SLES subscription with the CaaS Platform product key
* Disable Firewall
* Must have the same user across all nodes. Recommend use sles

.After installation complete:

* echo "sles ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
* Add the ssh key from the sles user on the Management Workstation to the authorized_keys file
* Verify proper subscriptions:
** sudo SUSEConnect -s
*** SLES must be registered before continuing
** sudo SUSEConnect -p sle-module-containers/15.1/x86_64
** sudo SUSEConnect -p caasp/4.0/x86_64 -r <CAASP_PRODUCT_KEY>
* zypper update
* zypper in cri-o
* zypper -n in autoyast
* yast2 clone_system
** Note the underscore, not dash
* Output file is /root/autoinst.xml
* Need to update the autoinst.xml file with:
<ntp-client>
<suse_register>
<addon>

Need to take note of: The default AutoYaST file provides examples for a disabled 
root user and a sles user with authorized key SSH access.

cp -p autoinst.xml worker1.xml
vi worker1.xml
* Change 105 (the IP of the base node) to 106 for <ipaddr>
* Change <hostname> from master to worker1
* scp to deployment host: scp worker1.xml admin@deployer.caaspv4.com:/home/admin/autoyast_templates/worker1.xml

.On the Management Workstation:
* Create the user sles
* (as root) echo "sles ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
* Verify proper subscriptions:
** sudo SUSEConnect -s
*** SLES must be registered before continuing
** sudo SUSEConnect -p sle-module-containers/15.1/x86_64
** sudo SUSEConnect -p caasp/4.0/x86_64 -r <CAASP_PRODUCT_KEY>
* Set up docker
Launch nginx container: docker run --name mynginx  -v /home/admin/autoyast_templates:/usr/share/nginx/html:ro -P -d nginx:latest
* Take note of the network port assigned to nginx
Test from master: curl http://deployer.caaspv4.com:<nginx port>/worker1.xml 

.Install worker hosts with AutoYaST:
* Start worker1 host from DVD ISO,  Select "Installation" at DVD GRuB screen, but DO NOT PRESS ENTER
* On Installation line: `autoyast=http://deployer.caaspv4.com:<nginx port>/worker1.xml ifcfg=eth0=<IP of worker1>/24,<IP of gateway>,<IP of DNS server,<search domain> hostname=worker1.caaspv4.com
* Repeat for worker2 and worker3

.Notes for skuba installation:

* Need a single SSH key and ssh-agent enabled:
** As the deployment user (sles in the deployment guide): 
*** Ensure it has an id_rsa key in ~/.ssh/
**** If not: ssh-keygen
***** Accept the defaults
* Start SSH Agent: eval "$(ssh-agent)"
* Check to see if it imported the local user's default key: ssh-add -l
** If not: ssh-add /home/sles/.ssh/id_rsa.pub

* NOTE: Need to test this: "The product key for SUSE CaaS Platform 4 also contains the activation permissions 
                            for the underlying SUSE Linux Enterprise operating system. You can use your SUSE CaaS 
                            Platform product key to activate the SUSE Linux Enterprise 15 SP1 subscription during installation."

* Install skuba tools: sudo zypper in -t pattern SUSE-CaaSP-Management

* Make sure you are the user sles 
skuba cluster init --control-plane master.caaspv4.com caaspv4-cluster
cd caaspv4-cluster/


skuba node bootstrap --user sles --sudo --target master.caaspv4.com master






// vim: set syntax=asciidoc:
