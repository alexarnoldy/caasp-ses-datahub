sudo -i
Update the DNS file with all nodes

.Install cluster nodes:

Install master node:
Deploy Deployment host O/S: Set IP on Grub line, enable repos: CaaSPv4, Containers, Package Hub
* Can enable SLES subscription with the CaaS Platform product key
* Disable Firewall
* Must have the same user across all nodes. Recommend use sles

.After installation complete:
* Set up bonded network ports
* echo "sles ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
* Add the ssh key from the sles user on the Management Workstation to the authorized_keys file
* Verify proper subscriptions:
** sudo SUSEConnect -s
*** SLES must be registered before continuing
** sudo SUSEConnect -p sle-module-containers/15.1/x86_64
** sudo SUSEConnect -p caasp/4.0/x86_64 -r <CAASP_PRODUCT_KEY>
* zypper update
* zypper in cri-o
* zypper -n in autoyast
* yast2 clone_system
** Note the underscore, not dash
* Output file is /root/autoinst.xml
* Need to update the autoinst.xml file with:
<ntp-client>
<suse_register>
<addon>

Need to take note of: The default AutoYaST file provides examples for a disabled 
root user and a sles user with authorized key SSH access.

cp -p autoinst.xml worker1.xml
vi worker1.xml
* Change 105 (the IP of the base node) to 106 for <ipaddr>
* Change <hostname> from master to worker1
* scp to deployment host: scp worker1.xml admin@deployer.caaspv4.com:/home/admin/autoyast_templates/worker1.xml

.On the Management Workstation:
* Create the user sles
* (as root) echo "sles ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
* Verify proper subscriptions:
** sudo SUSEConnect -s
*** SLES must be registered before continuing
** sudo SUSEConnect -p sle-module-containers/15.1/x86_64
** sudo SUSEConnect -p caasp/4.0/x86_64 -r <CAASP_PRODUCT_KEY>
* Set up docker
Launch nginx container: docker run --name mynginx  -v /home/admin/autoyast_templates:/usr/share/nginx/html:ro -P -d nginx:latest
* Take note of the network port assigned to nginx
Test from master: curl http://deployer.caaspv4.com:<nginx port>/worker1.xml 

.Install worker hosts with AutoYaST:
* Start worker1 host from DVD ISO,  Select "Installation" at DVD GRuB screen, but DO NOT PRESS ENTER
* On Installation line: `autoyast=http://deployer.caaspv4.com:<nginx port>/worker1.xml ifcfg=eth0=<IP of worker1>/24,<IP of gateway>,<IP of DNS server,<search domain> hostname=worker1.caaspv4.com
* Repeat for worker2 and worker3

.Notes for skuba installation:

* Need a single SSH key and ssh-agent enabled:
** As the deployment user (sles in the deployment guide): 
*** Ensure it has an id_rsa key in ~/.ssh/
**** If not: ssh-keygen
***** Accept the defaults
* Start SSH Agent: eval "$(ssh-agent)"
* Check to see if it imported the local user's default key: ssh-add -l
** If not: ssh-add /home/sles/.ssh/id_rsa.pub

* NOTE: Need to test this: "The product key for SUSE CaaS Platform 4 also contains the activation permissions 
                            for the underlying SUSE Linux Enterprise operating system. You can use your SUSE CaaS 
                            Platform product key to activate the SUSE Linux Enterprise 15 SP1 subscription during installation."

* Install skuba tools: sudo zypper in -t pattern SUSE-CaaSP-Management

* Make sure you are the user sles 
skuba cluster init --control-plane master.caaspv4.com caaspv4-cluster
cd caaspv4-cluster/


skuba node bootstrap --user sles --sudo --target master.caaspv4.com master







